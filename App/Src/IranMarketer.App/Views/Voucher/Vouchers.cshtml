@Html.Partial("_RegisterLastVersionOfKendo")
@using Kendo.Mvc.UI
@using Pikad.Framework.Infra.Utility
@using IranMarketer.Domain.DTO
@using IranMarketer.Domain.Entity

@{
    Layout = "../Shared/_Layout.cshtml";
    ViewBag.Title = "فهرست اسناد";
}
<div>
    <div class="panel-heading">
        <h5 class="panel-title">فهرست اسناد</h5>

    </div>
    <div id="filterPanel" class="panel panel-flat">
        <div class="panel-heading">
            <h5 class="panel-title">فیلتر جستجو</h5>
            <div class="heading-elements">
                <ul class="icons-list">
                    <li><a data-action="collapse"></a></li>

                </ul>
            </div>
        </div>

        <div class="panel-body">
            <div class="row" style="clear: both;">
                <div class="form-group col-md-6">
                    <label>شماره سند</label>
                    <input type="text" class="form-control" placeholder="شماره سند" id="VoucherNumber">
                </div>
                <div class="form-group col-md-6">
                    <label>شماره سیستمی سند</label>
                    <input type="text" class="form-control" placeholder="شماره سیستمی" id="voucherid">
                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-6">
                    <label>شعبه</label>
                    @(Html.Kendo().ComboBox().Name("BranchId").HtmlAttributes(new { @class = "form-control k-rtl" })
                          .DataTextField("BranchTitle")
                          .Filter(FilterType.Contains)
                          .DataValueField("BranchValue")
                          .AutoBind(true)
                          .DataSource(source => source.Read(read => read.Action("GetBranchesDropDownListById", "UIComponent").Data("onadditionalData1")).ServerFiltering(false)))
                </div>
                <div class="form-group col-md-6">
                    <label>نوع ثبت</label>
                    @(Html.Kendo().ComboBox().Name("InsertModeType").HtmlAttributes(new { @class = "form-control k-rtl" })
                          .DataTextField("Title")
                          .Filter(FilterType.Contains)
                          .DataValueField("Value")
                          .AutoBind(true)
                          .DataSource(source => source.Read(read => read.Action("GetVoucherInsertModeType", "UIComponent")).ServerFiltering(false)))
                </div>
            </div>
            <div class="row">
                <div class="form-group col-md-6">
                    <label>سال مالی</label>
                    @(Html.Kendo().DropDownList().Name("FiscalYearId").HtmlAttributes(new { @class = "form-control k-rtl" })
                          .DataTextField("Title")
                          .Filter(FilterType.Contains)
                          .DataValueField("Id")
                          .SelectedIndex(0)
                          .Events(x =>
                          {
                              x.Change("onfiscalYearChange");
                              x.DataBound("onfiscalYearChange");

                          })
                          .AutoBind(true)
                          .DataSource(source => source.Read(read => read.Action("GetFiscalYears", "UIComponent")).ServerFiltering(false)))

                </div>
                <div class="form-group col-md-6">
                    <label>نوع سند</label>
                    @(Html.Kendo().DropDownList().Name("VoucherCategory").HtmlAttributes(new { @class = "form-control k-rtl", style = "width:70%" })
                          .DataTextField("Title")
                          .Filter(FilterType.Contains)
                          .DataValueField("Value")
                          .SelectedIndex(0)
                          .AutoBind(true)
                          .DataSource(source => source.Read(read => read.Action("GetVoucherCategories", "UIComponent", new { addAll = true })).ServerFiltering(false)))

                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-6">
                    <label> تاریخ سند از</label>
                    @Html.Kendo().DatePicker().Name("FromDate").HtmlAttributes(new { style = "width:250px", type = "text" }).Format("yyyy/MM/dd")
                    <span class="text-danger">*</span>
                </div>
                <div class="form-group col-md-6">
                    <label>تاریخ سند تا</label>
                    @Html.Kendo().DatePicker().Name("ToDate").HtmlAttributes(new { style = "width:250px", type = "text" }).Format("yyyy/MM/dd")
                    <span class="text-danger">*</span>
                </div>
            </div>

            <div class="text-right">
                <button type="button" id="search" class="btn btn-primary">جست و جو <i class="icon-arrow-left13 position-right"></i></button>
            </div>
        </div>
    </div>

    <div class="panel panel-body" style="min-height: 680px;font-size: 12px">
        <div class="k-rtl">
            @(Html.Kendo().Grid<IranMarketer.Domain.DTO.VoucherMaster>()
                  .Name("grid")
                  .Columns(column =>
                  {
                      column.Bound(x => x.Id).ClientTemplate("<a href ='/Voucher/ViewVoucherDetails?vid=${Id}&fid=${FiscalYearId}'>${Id}</a>").Title("شماره سیستمی").Width(80);
                      column.Bound(x => x.VoucherNumber).Title("شماره سند").Width(80);
                      column.Bound(x => x.Description).Title("عنوان").Width(190);
                      column.Bound(x => x.VoucherDateJalali).Title("تاریخ سند").Width(80);
                      column.Bound(x => x.BranchName).Title("شعبه").Width(80);
                      column.Bound(x => x.InsertModeTitle).Title("نحوه ثبت").Width(60);
                      column.Bound(x => x.CreatedJalali).Title("تاریخ ایجاد").Width(80);
                      column.Bound(x => x.VoucherCategoryTitle).Title("نوع سند").Width(80);
                  })
                  .ToolBar(x =>
                  {
                      x.Excel().Text("Excel");
                  })
                  .Excel(excel => excel
                      .FileName("VoucherExcelReport.xlsx")
                      .Filterable(true)
                      .AllPages(true)
                      .ForceProxy(true)
                      .AllPages(true)
                      .ProxyURL(Url.Action("VoucherExcelReport", "Voucher"))
                  )
                  .Sortable(sortable => sortable.AllowUnsort(false))
                  .Pageable(pager => pager
                      .Input(true)
                      .Numeric(true)
                      .Info(true)
                      .PreviousNext(true)
                      .Refresh(true)
                      .PageSizes(new[] { 100, 150, 200, 250 }))

                  .AllowCopy(true)
                  .Selectable(x => x.Mode(GridSelectionMode.Multiple))
                  .Scrollable()
                  .ColumnMenu(e =>
                  {
                      e.Columns(true);

                  })
                  .AutoBind(false)
                  .HtmlAttributes(new { style = "height:620px;" })
                  .DataSource(dataSource =>
                      dataSource.Custom()
                          .Type("aspnetmvc-ajax")
                          .PageSize(100)
                          .ServerPaging(true)
                          .ServerSorting(true)
                          .ServerFiltering(true)
                          .Transport(transport => transport
                              .Read(read => read.Action("GetFlatAllVouchers", "Voucher").Data("filterData").Type(HttpVerbs.Post))
                          )
                          .Schema(s => s.Data("Result").Total("TotalRecords"))
                  )

                  .Resizable(resize => resize.Columns(true))
                  .Reorderable(reorder => reorder.Columns(true)))

        </div>
    </div>
</div>
<style type="text/css">
    .form-horizontal .form-group {
        margin-right: 0 !important;
        margin-left: 0 !important;
    }

    .form-group-material > .control-label {
        opacity: 1 !important;
        filter: alpha(opacity=0);
    }


    .dropdown-header {
        /*font-size: 1.2em;*/
        padding: 0px 0px;
        text-align: right;
    }

        .dropdown-header > span {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            text-align: right;
            display: inline-block;
            border-style: solid;
            border-width: 0 0 1px 1px;
            padding: .3em .6em;
            width: 150px;
        }

            .dropdown-header > span:first-child {
                width: 150px;
                border-left-width: 0;
            }
</style>

<script>
    $(document).ready(function () {

    });


    function onfiscalYearChange() {
        var dataItem = $("#FiscalYearId").data("kendoDropDownList").dataItem();
        if (dataItem != null) {
            $("#ToDate").val(dataItem.EndDateJalali);
            $("#FromDate").val(dataItem.StartDateJalali);
        }
    }

    function onSelect(e) {

        // $("#custometfullname").text(dataItem.FullName);
    }

    function onDataBound(e) {

    }

    function onFiltering() {

    }

    function onadditionalData1() {
        return {
            text: $('[name="BranchId_input"]').val()
        };
    }


    function filterData() {

        var data = {

            VoucherNumber: $("#VoucherNumber").val(),
            VoucherMasterId: $("#voucherid").val(),
            BranchId: $("#BranchId").data("kendoComboBox").dataItem() != null ? $("#BranchId").data("kendoComboBox").dataItem().BranchValue : "-1",
            //BranchId: "-1",
            FromDate: $("#FromDate").val(),
            ToDate: $("#ToDate").val(),
            FiscalYearId: $("#FiscalYearId").val(),
            VoucherCategoryEnum: $("#VoucherCategory").val(),
            VoucherInsertMode: $("#InsertModeType").val()
        }
        if (!$('#filterPanel').hasClass('panel-collapsed'))
            $('#filterPanel [data-action=collapse]').click();
        return { model: data };
    }
    $("#search").click(function () {

        $("#grid").data("kendoGrid").dataSource.read();

    });

</script>